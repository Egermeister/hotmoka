# In order to create the image:
#   docker build -t hotmoka/single-validator:latest -f dockerfiles/single-validator/single-validator .

# In order to publish a node at port 80:
#   moka create-key
# then use the resulting key below:
#   docker run -dit -e INITIAL_SUPPLY=123456789 -e OPEN_UNSIGNED_FAUCET=false -e ALLOW_MINT_BURN_FROM_GAMETE=false -e KEY_OF_GAMETE=key -e CHAIN_ID=id -e OBLIVION=250000 -e INITIAL_GAS_PRICE=100 -p 80:8080 -v chain:/home/hotmoka/chain hotmoka/single-validator:latest [init|restart]

# in the future, move to 11.0.13-jre-slim
FROM openjdk:11.0.13
LABEL "maintainer"="fausto.spoto@hotmoka.io"

USER root
WORKDIR /usr/local/bin
    
# install missing packages
RUN apt-get update \
  && apt-get install -y wget \
  && rm -rf /var/lib/apt/lists/*

# create hotmoka user
RUN groupadd -r hotmoka \
  && useradd --no-log-init -r -m -g hotmoka hotmoka

# create a volume for the chain of this container and make it writable to everyone
RUN mkdir /home/hotmoka/chain \
  && chmod -R a+w /home/hotmoka/chain

# install moka
COPY modules/ /modules/
# we add /home/hotmoka to the classpath in order to find the log4j configuration file
RUN echo java -Dlog4j.configuration=hotmoka.log4j.properties --module-path /modules/explicit:/modules/automatic --class-path \"/home/hotmoka/:/modules/unnamed/*\" --module io.hotmoka.tools/io.hotmoka.tools.Moka \"\$@\" > moka \
  && chmod a+x moka

# install tendermint
RUN wget https://github.com/tendermint/tendermint/releases/download/v0.34.14/tendermint_0.34.14_linux_amd64.tar.gz \
  && tar -zxvf tendermint_0.34.14_linux_amd64.tar.gz tendermint \
  && chown root.staff tendermint \
  && chmod 755 tendermint \
  && rm tendermint_*.tar.gz

# install the control scripts
COPY dockerfiles/single-validator/init.sh init.sh
COPY dockerfiles/single-validator/restart.sh restart.sh
RUN chmod 755 init.sh && chmod 755 restart.sh

USER hotmoka
WORKDIR /home/hotmoka
COPY --chown=hotmoka dockerfiles/log4j.properties hotmoka.log4j.properties

# by default, turn up a brand new node
CMD init