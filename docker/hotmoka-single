# in the future, move to 11.0.13-jre-slim
FROM openjdk:11.0.13
LABEL "maintainer"="fausto.spoto@hotmoka.io"

# install missing packages
RUN  apt-get update \
  && apt-get install -y wget \
  && rm -rf /var/lib/apt/lists/*

# install moka
COPY modules/ /modules/
WORKDIR /usr/local/bin
RUN echo java --module-path /modules/explicit:/modules/automatic --class-path \"/modules/unnamed/*\" --module io.hotmoka.tools/io.hotmoka.tools.Moka \"\$@\" > moka
RUN chmod a+x moka

# install tendermint
RUN wget https://github.com/tendermint/tendermint/releases/download/v0.34.10/tendermint_0.34.10_linux_amd64.tar.gz
RUN tar -zxvf tendermint_0.34.10_linux_amd64.tar.gz tendermint
RUN chown root.staff tendermint
RUN chmod a+x tendermint
RUN rm tendermint_*.tar.gz

# create hotmoka user
RUN groupadd -r hotmoka \
  && useradd --no-log-init -r -m -g hotmoka hotmoka
USER hotmoka
WORKDIR /home/hotmoka

# create tendermint configuration
COPY --chown=hotmoka io-hotmoka-tools/tendermint_configs/v1n0/node0/ tendermint_config

# by default, turn up the node
CMD moka init-tendermint 100000000000000000 --non-interactive --open-unsigned-faucet --password-of-gamete=pippo --takamaka-code /modules/explicit/io-takamaka-code-1.0.5.jar --tendermint-config=tendermint_config
